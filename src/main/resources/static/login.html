<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Login (JWT)</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #out { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 20px; white-space: pre-wrap; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
<h2>JWT 로그인 테스트</h2>

<div class="form-group">
    <label>테스트 계정:</label>
    <p>
        관리자: admin@ticket.com / password123<br>
        사용자: user@ticket.com / password123<br>
        사용자명: testuser / password123
    </p>
</div>

<form id="loginForm">
    <div class="form-group">
        <label for="usernameOrEmail">이메일 또는 사용자명:</label>
        <input id="usernameOrEmail" name="usernameOrEmail" value="admin@ticket.com" placeholder="이메일 또는 사용자명 입력">
    </div>
    <div class="form-group">
        <label for="password">비밀번호:</label>
        <input id="password" name="password" type="password" value="password123" placeholder="비밀번호 입력">
    </div>
    <button type="submit">로그인</button>
</form>

<div id="out"></div>

<script>
    const loginForm = document.getElementById('loginForm');
    const outputDiv = document.getElementById('out');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const usernameOrEmail = document.getElementById('usernameOrEmail').value;
        const password = document.getElementById('password').value;

        outputDiv.innerHTML = '로그인 시도 중...';

        try {
            // 로그인 요청
            const loginResponse = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usernameOrEmail: usernameOrEmail,
                    password: password
                })
            });

            if (!loginResponse.ok) {
                const errorText = await loginResponse.text();
                outputDiv.innerHTML = `<div class="error">로그인 실패: ${loginResponse.status} - ${errorText}</div>`;
                return;
            }

            const loginData = await loginResponse.json();

            // 로컬 스토리지에 토큰 저장
            localStorage.setItem('accessToken', loginData.accessToken);
            localStorage.setItem('userType', loginData.userType);

            outputDiv.innerHTML = `<div class="success">
로그인 성공!
사용자 유형: ${loginData.userType}

JWT 토큰:
${loginData.accessToken}

토큰이 localStorage에 저장되었습니다.
</div>`;

            // Health check 테스트
            try {
                const healthResponse = await fetch('/actuator/health', {
                    headers: { 'Authorization': 'Bearer ' + loginData.accessToken }
                });

                const healthData = await healthResponse.text();
                outputDiv.innerHTML += `\n\n=== Health Check 테스트 ===\n상태: ${healthResponse.status}\n응답: ${healthData}`;

            } catch (healthError) {
                outputDiv.innerHTML += `\n\n=== Health Check 테스트 ===\n오류: ${healthError.message}`;
            }

        } catch (error) {
            outputDiv.innerHTML = `<div class="error">네트워크 오류: ${error.message}</div>`;
        }
    });

    // 페이지 로드 시 저장된 토큰 확인
    window.addEventListener('load', () => {
        const savedToken = localStorage.getItem('accessToken');
        const savedUserType = localStorage.getItem('userType');

        if (savedToken) {
            outputDiv.innerHTML += `<div style="color: #6c757d;">
저장된 토큰이 있습니다.
사용자 유형: ${savedUserType}
토큰: ${savedToken.substring(0, 50)}...
</div>`;
        }
    });
</script>
</body>
</html>