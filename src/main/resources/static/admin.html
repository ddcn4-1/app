<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>관리자 대시보드 - 티켓팅 시스템</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
        .header { background: #dc3545; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .status-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .admin-only { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #dc3545; }
        .btn { display: inline-block; background: #dc3545; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px; margin: 5px; border: none; cursor: pointer; }
        .btn:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .unauthorized { text-align: center; padding: 50px; }
    </style>
</head>
<body>
<div class="header">
    <h1>관리자 대시보드</h1>
    <div>
        <span id="adminInfo">로딩 중...</span>
        <button class="logout-btn" onclick="adminLogout()">로그아웃</button>
    </div>
</div>

<div class="container">
    <div class="admin-only">
        🔒 관리자 전용 영역입니다. ADMIN 권한이 필요합니다.
    </div>

    <div id="unauthorizedMessage" class="unauthorized" style="display: none;">
        <h2>접근 권한이 없습니다</h2>
        <p>관리자 로그인이 필요합니다.</p>
        <a href="/admin-login.html" class="btn">관리자 로그인</a>
    </div>

    <div id="adminContent">
        <div class="status-card">
            <h2>시스템 상태</h2>
            <div id="systemStatus">상태 확인 중...</div>
            <button class="btn btn-secondary" onclick="checkSystemStatus()">상태 새로고침</button>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>사용자 관리</h3>
                <p>시스템 사용자를 관리합니다.</p>
                <button class="btn" onclick="alert('사용자 관리 기능 구현 예정')">사용자 목록</button>
                <button class="btn btn-secondary" onclick="alert('구현 예정')">권한 관리</button>
            </div>

            <div class="card">
                <h3>시스템 모니터링</h3>
                <p>서버 상태와 성능을 모니터링합니다.</p>
                <button class="btn" onclick="checkHealth()">Health Check</button>
                <button class="btn btn-secondary" onclick="alert('구현 예정')">로그 확인</button>
            </div>

            <div class="card">
                <h3>설정 관리</h3>
                <p>시스템 설정을 관리합니다.</p>
                <button class="btn" onclick="alert('구현 예정')">일반 설정</button>
                <button class="btn btn-secondary" onclick="alert('구현 예정')">보안 설정</button>
            </div>
        </div>
    </div>

    <div id="results" style="margin-top: 20px;"></div>
</div>

<script>
    // 페이지 로드 시 관리자 권한 확인
    window.addEventListener('load', () => {
        checkAdminAccess();
    });

    function checkAdminAccess() {
        const token = localStorage.getItem('accessToken');
        const userType = localStorage.getItem('userType');

        if (!token || userType !== 'ADMIN') {
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('unauthorizedMessage').style.display = 'block';
            document.getElementById('adminInfo').textContent = '권한 없음';
            return;
        }

        // 관리자 상태 확인
        checkAdminStatus();
    }

    async function checkAdminStatus() {
        const token = localStorage.getItem('accessToken');

        try {
            const response = await fetch('/admin/auth/status', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('adminInfo').textContent = `${data.admin} (${data.role})`;
            } else if (response.status === 401 || response.status === 403) {
                // 토큰이 유효하지 않거나 권한 없음
                localStorage.removeItem('accessToken');
                localStorage.removeItem('userType');
                checkAdminAccess();
            } else {
                document.getElementById('adminInfo').textContent = '상태 확인 실패';
            }
        } catch (error) {
            console.error('관리자 상태 확인 실패:', error);
            document.getElementById('adminInfo').textContent = '연결 오류';
        }
    }

    async function adminLogout() {
        const token = localStorage.getItem('accessToken');

        try {
            const response = await fetch('/admin/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            // 로컬 스토리지에서 토큰 삭제
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userType');

            document.getElementById('results').innerHTML = `
                    <div class="success">
                        관리자 로그아웃 완료: ${result.message}
                    </div>
                `;

            // 2초 후 로그인 페이지로 리다이렉트
            setTimeout(() => {
                window.location.href = '/admin/login';  // .html 제거
            }, 2000);

        } catch (error) {
            console.error('로그아웃 실패:', error);
            // 에러가 발생해도 클라이언트 토큰은 삭제
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userType');
            window.location.href = '/admin-login.html';
        }
    }

    function checkSystemStatus() {
        document.getElementById('systemStatus').innerHTML = `
                서버: 정상 운영 중<br>
                데이터베이스: 연결됨<br>
                Redis: 연결됨<br>
                마지막 확인: ${new Date().toLocaleString()}
            `;
    }

    async function checkHealth() {
        const token = localStorage.getItem('accessToken');

        try {
            const response = await fetch('/actuator/health', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.text();
            document.getElementById('results').innerHTML = `
                    <div class="success">
                        <strong>Health Check 결과:</strong><br>
                        상태: ${response.status}<br>
                        응답: ${data}
                    </div>
                `;
        } catch (error) {
            document.getElementById('results').innerHTML = `
                    <div class="error">
                        Health Check 실패: ${error.message}
                    </div>
                `;
        }
    }

    // 초기 시스템 상태 확인
    setTimeout(checkSystemStatus, 1000);
</script>
</body>
</html>